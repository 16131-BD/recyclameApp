<div class="page-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-header-content">
      <div class="page-title-wrapper">
        <h1 class="page-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
          Operaciones Autorizadas
        </h1>
        <p class="page-subtitle">Administra los tipos de operaciones autorizadas en el sistema</p>
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        Nueva Operacion
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-mini-grid">
    <div class="stat-mini-card total">
      <div class="stat-mini-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/></svg>
      </div>
      <div class="stat-mini-value">{{ totalOperaciones() }}</div>
      <div class="stat-mini-label">Total</div>
    </div>
    <div class="stat-mini-card completed">
      <div class="stat-mini-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
      </div>
      <div class="stat-mini-value">{{ activeOperaciones() }}</div>
      <div class="stat-mini-label">Activas</div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" placeholder="Buscar por codigo o nombre..." class="search-input" [value]="searchTerm()" (input)="updateSearch($event)">
    </div>
  </div>

  <!-- Messages -->
  @if (successMessage()) {
    <div class="alert alert-success">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
      {{ successMessage() }}
    </div>
  }
  @if (errorMessage()) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
      {{ errorMessage() }}
    </div>
  }

  <!-- Data Table -->
  <div class="data-card">
    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Cargando operaciones autorizadas...</p>
      </div>
    } @else if (filteredOperaciones().length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/></svg>
        </div>
        <h3>No se encontraron operaciones</h3>
        <p>{{ searchTerm() ? 'Intenta con otros terminos de busqueda' : 'Comienza agregando una nueva operacion autorizada' }}</p>
        @if (!searchTerm()) {
          <button class="btn btn-primary" (click)="openCreateModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            Agregar Operacion
          </button>
        }
      </div>
    } @else {
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 80px;">Orden</th>
              <th style="width: 100px;">Codigo</th>
              <th>Nombre</th>
              <th>Descripcion</th>
              <th style="width: 100px;">Estado</th>
              <th class="text-center" style="width: 120px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (operacion of filteredOperaciones(); track operacion._id || operacion.code) {
              <tr>
                <td><span class="order-badge">{{ operacion.order }}</span></td>
                <td><span class="code-badge">{{ operacion.code }}</span></td>
                <td><div class="cell-main">{{ operacion.name }}</div></td>
                <td><div class="cell-description">{{ operacion.description || '-' }}</div></td>
                <td>
                  <span class="status-badge" [class.active]="operacion.is_active" [class.inactive]="!operacion.is_active">
                    <span class="status-dot"></span>
                    {{ operacion.is_active ? 'Activo' : 'Inactivo' }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-icon" title="Ver detalles" (click)="openViewModal(operacion)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                    <button class="btn-icon" title="Editar" (click)="openEditModal(operacion)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                    </button>
                    <button class="btn-icon" [class.danger]="operacion.is_active" [class.success]="!operacion.is_active" [title]="operacion.is_active ? 'Desactivar' : 'Activar'" (click)="toggleActive(operacion)">
                      @if (operacion.is_active) {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                      } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                      }
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <div class="table-footer">
        <span class="results-count">Mostrando {{ filteredOperaciones().length }} de {{ totalOperaciones() }} operaciones</span>
      </div>
    }
  </div>
</div>

<!-- Modal -->
@if (modalMode()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          @switch (modalMode()) {
            @case ('create') { Nueva Operacion Autorizada }
            @case ('edit') { Editar Operacion Autorizada }
            @case ('view') { Detalles de Operacion }
          }
        </h2>
        <button class="modal-close" (click)="closeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        @if (modalMode() === 'view' && selectedOperacion()) {
          <div class="detail-grid">
            <div class="detail-item"><label>Orden</label><span class="order-badge large">{{ selectedOperacion()!.order }}</span></div>
            <div class="detail-item"><label>Codigo</label><span class="code-badge large">{{ selectedOperacion()!.code }}</span></div>
            <div class="detail-item full-width"><label>Nombre</label><span>{{ selectedOperacion()!.name }}</span></div>
            <div class="detail-item full-width"><label>Descripcion</label><span>{{ selectedOperacion()!.description || '-' }}</span></div>
            <div class="detail-item"><label>Estado</label><span class="status-badge" [class.active]="selectedOperacion()!.is_active" [class.inactive]="!selectedOperacion()!.is_active"><span class="status-dot"></span>{{ selectedOperacion()!.is_active ? 'Activo' : 'Inactivo' }}</span></div>
            <div class="detail-item"><label>Fecha de Creacion</label><span>{{ formatDate(selectedOperacion()!.created_at) }}</span></div>
          </div>
        } @else {
          @if (errorMessage()) {
            <div class="alert alert-error mb-4">{{ errorMessage() }}</div>
          }
          @if (successMessage()) {
            <div class="alert alert-success mb-4">{{ successMessage() }}</div>
          }
          <form class="form-grid" (ngSubmit)="saveOperacion()">
            <div class="form-group"><label for="order">Orden <span class="required">*</span></label><input type="number" id="order" [(ngModel)]="formData.order" name="order" placeholder="1" min="1" class="form-control"></div>
            <div class="form-group"><label for="code">Codigo <span class="required">*</span></label><input type="text" id="code" [(ngModel)]="formData.code" name="code" placeholder="Ej: REC" [disabled]="modalMode() === 'edit'" class="form-control" style="text-transform: uppercase;"></div>
            <div class="form-group full-width"><label for="name">Nombre <span class="required">*</span></label><input type="text" id="name" [(ngModel)]="formData.name" name="name" placeholder="Ej: Recoleccion y transporte" class="form-control"></div>
            <div class="form-group full-width"><label for="description">Descripcion</label><textarea id="description" [(ngModel)]="formData.description" name="description" placeholder="Descripcion de la operacion..." class="form-control" rows="3"></textarea></div>
            <div class="form-group"><label class="toggle-label"><input type="checkbox" [(ngModel)]="formData.is_active" name="is_active" class="toggle-input"><span class="toggle-switch"></span><span class="toggle-text">Operacion activa</span></label></div>
          </form>
        }
      </div>
      <div class="modal-footer">
        @if (modalMode() === 'view') {
          <button class="btn btn-secondary" (click)="closeModal()">Cerrar</button>
          <button class="btn btn-primary" (click)="openEditModal(selectedOperacion()!)">Editar</button>
        } @else {
          <button class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
          <button class="btn btn-primary" (click)="saveOperacion()" [disabled]="isSaving()">
            @if (isSaving()) { Guardando... } @else { {{ modalMode() === 'create' ? 'Crear Operacion' : 'Guardar Cambios' }} }
          </button>
        }
      </div>
    </div>
  </div>
}
